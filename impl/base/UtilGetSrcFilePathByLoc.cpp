// Created by z on 2024/6/8.

#include <filesystem>
#include <fstream>
#include <iostream>
#include <string>
#include <clang/AST/ParentMapContext.h>
#include "UtilGetSrcFilePathByLoc.h"
#include "base/UtilParentKind.h"
#include "clang/Frontend/FrontendPluginRegistry.h"
#include "clang/Basic/SourceManager.h"
#include "clang/AST/Stmt.h"
#include <clang/Frontend/CompilerInstance.h>
#include <clang/Rewrite/Core/Rewriter.h>
#include "base/Util.h"
#include "base/UtilGetSrcFilePathByLoc.h"

/**
 * 获取语句所属源文件路径
 */
void UtilGetSrcFilePathByLoc::getSourceFilePathOfStmt(const Stmt *S, const SourceManager &SM, StringRef& fn) {
  SourceLocation Loc = S->getBeginLoc();
  UtilGetSrcFilePathByLoc::getSourceFilePathAtLoc(Loc, SM, fn);
}

/**
 * 获取位置所属源文件路径
 * 获取语句所属源文件路径
 * code by chatgpt on : https://chat.chatgptdemo.net/
 * @param S
 * @param SM
 * @param fn
 * @return
 */
bool UtilGetSrcFilePathByLoc::getSourceFilePathAtLoc(SourceLocation Loc, const SourceManager &SM, StringRef& fn) {
//  SourceLocation Loc = S->getBeginLoc();
  if (Loc.isValid()) {
    FileID File = SM.getFileID(Loc);
    const FileEntry *FE = SM.getFileEntryForID(File);
    if (FE) {
      fn=FE->getName();
//      llvm::outs() << "Source File Path: " << FE->getName() << "\n";
      return true;
    }
  }
  return false;
}